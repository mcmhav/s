#!/usr/bin/env bash

read -ra ORIGINAL_ARGS <<<"$*"

PACKAGE_TO_INSTALL=""
while [ "$1" != "" ]; do
  case "$1" in
  -*) ;;
  *)
    if [ -z "$PACKAGE_TO_INSTALL" ]; then
      PACKAGE_TO_INSTALL="$1"
    fi
    ;;
  esac
  shift
done

if [ -f "$CSYS_PROGRAMS/$PACKAGE_TO_INSTALL/setup.sh" ]; then
  if [ -f "$CSYS_PROGRAMS/$PACKAGE_TO_INSTALL/reqs" ]; then
    # TODO: issue with while-loop and brew install?
    # while read -r l; do
    for l in $(cat $CSYS_PROGRAMS/$PACKAGE_TO_INSTALL/reqs); do
      loggit dbug "csys-reqs | Will install $l"
      csys install "$l"
    done
    # done <"$CSYS_PROGRAMS/$PACKAGE_TO_INSTALL/reqs"
  fi
  loggit dbug "csys | Setup $PACKAGE_TO_INSTALL"
  "$CSYS_PROGRAMS/$PACKAGE_TO_INSTALL/setup.sh"
else
  loggit dbug "brew | Setup $PACKAGE_TO_INSTALL"
  if ! csys is-package-installed "${ORIGINAL_ARGS[@]}"; then
    brew install "${ORIGINAL_ARGS[@]}"
  fi
fi
