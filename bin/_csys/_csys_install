#!/usr/bin/env bash

read -ra ORIGINAL_ARGS <<<"$*"

PACKAGE_TO_INSTALL=""
SHALLOW_SETUP=""
while [ "$1" != "" ]; do
  case "$1" in
  "$CSYS_SHALLOW_FLAG")
    SHALLOW_SETUP="$1"
    ;;
  -*) ;;
  *)
    if [ -z "$PACKAGE_TO_INSTALL" ]; then
      PACKAGE_TO_INSTALL="$1"
    fi
    ;;
  esac
  shift
done

if [ -f "$CSYS_PROGRAMS/$PACKAGE_TO_INSTALL/setup.sh" ]; then
  if [ -f "$CSYS_PROGRAMS/$PACKAGE_TO_INSTALL/reqs" ]; then
    while read -r l; do
      csys install "$l"
    done <"$CSYS_PROGRAMS/$PACKAGE_TO_INSTALL/reqs"
  fi
  loggit dbug "csys | Setup $PACKAGE_TO_INSTALL"
  "$CSYS_PROGRAMS/$PACKAGE_TO_INSTALL/setup.sh" "$SHALLOW_SETUP"
else
  loggit dbug "brew | Setup $PACKAGE_TO_INSTALL"
  if
    {
      [ "$CSYS_SHALLOW_SETUP" = "true" ] &&
        ! command -v "$PACKAGE_TO_INSTALL" >/dev/null &&
        ! ls "/usr/local/Cellar/$PACKAGE_TO_INSTALL" 1>/dev/null 2>&1 &&
        ! ls "/usr/local/Caskroom/$PACKAGE_TO_INSTALL" 1>/dev/null 2>&1 &&
        ! brew ls --version "${ORIGINAL_ARGS[@]}" >/dev/null
    } ||
      {
        [ "$CSYS_SHALLOW_SETUP" = "false" ] &&
          ! brew ls --version "${ORIGINAL_ARGS[@]}" >/dev/null
      }
  then
    brew install "${ORIGINAL_ARGS[@]}"
  fi
fi
