#!/usr/bin/env bash

source param_parser --params "l i" --incomming_params "$@"

_find_in_files() {
  search_location="."
  if [ -n "$PARAM_L" ]; then
    search_location="$PARAM_L"
  fi

  EXTRA_IGNORE=""
  if [ -n "$PARAM_I" ]; then
    EXTRA_IGNORE="--ignore $PARAM_I"
  fi

  ag_fzf_result=$(cd "$search_location" && ag --noheading --hidden --ignore ".git" "." $EXTRA_IGNORE | fzf -e)

  ag_fzf_result="$search_location/$ag_fzf_result"

  selected_file=$(echo "$ag_fzf_result" | awk 'BEGIN {FS=":";} { print $1 }')
  selected_line_num=$(echo "$ag_fzf_result" | awk 'BEGIN {FS=":";} { print $2 }')

  if [ -n "$selected_file" ] && [ "$selected_file" != "./" ]; then
    vim "$selected_file" +"$selected_line_num"
    echo "$selected_file"
  fi
}

_find_in_files "$@"
