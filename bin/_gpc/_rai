#!/usr/bin/env bash

SCRIPT_PATH="$(cd "$(dirname "${BASH_SOURCE[0]}")" >/dev/null 2>&1 && pwd)"

WORKSPACE_IDS_RUNNING="$("$SCRIPT_PATH/_get_workspace_ids" running | tr ' ' '\n')"
WORKSPACE_IDS_STOPPED="$("$SCRIPT_PATH/_get_workspace_ids" stopped | tr ' ' '\n')"
WORKSPACE_IDS=""
if [ -n "$WORKSPACE_IDS_RUNNING" ]; then
  WORKSPACE_IDS=$(echo "$WORKSPACE_IDS_RUNNING" | sed 's|$| # Running|g')
fi
if [ -n "$WORKSPACE_IDS_STOPPED" ]; then
  WORKSPACE_IDS="$(printf '%s\n%s' "$WORKSPACE_IDS" "$(echo "$WORKSPACE_IDS_STOPPED" | sed 's|$| # Stopped|g')")"
fi
WORKSPACE_ID=$(echo "$WORKSPACE_IDS" | awk 'NF' | fzf -e)
WORKSPACE_ID=$(echo "$WORKSPACE_ID" | sed 's| #.*$||g')
if [ -z "$WORKSPACE_ID" ]; then
  loggit errr "No workspace selected"
  exit 1
fi
if echo "$WORKSPACE_IDS_STOPPED" | grep -q "$WORKSPACE_ID"; then
  echo "Should open workspace"
  "$SCRIPT_PATH/_open" --workspace-id "$WORKSPACE_ID"
  "$SCRIPT_PATH/_wait_for_workspace_to_start" "$WORKSPACE_ID"
fi
loggit "Will ssh into $WORKSPACE_ID"
"$SCRIPT_PATH/_ssh_into_workspace" "$WORKSPACE_ID"
