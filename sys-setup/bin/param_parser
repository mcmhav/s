#!/usr/bin/env bash

INCOMMING_PARAMS=""
PARAMS=""

# https://stackoverflow.com/questions/192249/how-do-i-parse-command-line-arguments-in-bash
while getopts "h-:" optchar; do
  case "${optchar}" in
    - )
      case "${OPTARG}" in
        incomming_params )
          shift $((OPTIND-1))
          IFS=' ' read -r -a INCOMMING_PARAMS <<< "$@"
          break
          ;;
        params )
          PARAMS="${!OPTIND}"
          IFS=' ' read -r -a PARAMS <<< "${!OPTIND^^}"
          OPTIND=$((OPTIND+1))
          ;;
        * )
          OPTIND=$((OPTIND+1))
          ;;
      esac ;;
    * ) shift ;;
  esac
done

INCOMMING_PARAM="${INCOMMING_PARAMS[0]}"
COUNT=0
INCOMMING_PARAM_COUNT=0

for param in "${PARAMS[@]}"; do
  INCOMMING_PARAMS_COUNT=0
  INCOMMING_PARAM="${INCOMMING_PARAMS[$COUNT]}"
  while [ "$INCOMMING_PARAM" != "" ]; do
    case "${INCOMMING_PARAM^^}" in
      -$param | --$param )
        if [[ ${INCOMMING_PARAMS[$((INCOMMING_PARAMS_COUNT+1))]} != -* ]] && \
           [[ ${INCOMMING_PARAMS[$((INCOMMING_PARAMS_COUNT+1))]} != "" ]]; then
          declare -n ref="PARAM_$param"
          export ref="${INCOMMING_PARAMS[$((INCOMMING_PARAMS_COUNT+1))]}"
          INCOMMING_PARAMS_COUNT=$((INCOMMING_PARAMS_COUNT+1))
        else
          declare -n ref="PARAM_$param"
          export ref=1
        fi
        ;;
      -- ) export PARAM_REST="${INCOMMING_PARAMS[@]:$((INCOMMING_PARAMS_COUNT+1))}" ;;
      * ) ;;
    esac
    INCOMMING_PARAMS_COUNT=$((INCOMMING_PARAMS_COUNT+1))
    INCOMMING_PARAM=${INCOMMING_PARAMS[$INCOMMING_PARAMS_COUNT]}
  done
  COUNT=$((COUNT+1))
done

